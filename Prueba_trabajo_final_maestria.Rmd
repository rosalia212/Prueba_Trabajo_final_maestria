---
title: "Analisis de patrones conductuales vinculados al rendimiento deportivo"
author: "Rosalia"
date: "2025-08-27"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
paquetes_necesarios <- c(
  "flexdashboard", "tidyverse", "readxl", "readr", "dplyr", "ggplot2",
  "ggrepel", "countrycode", "scales", "maps", "DT", "lorem", "png", "grid"
)

instalar_si_falta <- function(pkg) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    install.packages(pkg)
  }
}
message("Todos los paquetes necesarios están instalados.")

library(tidyverse)
library(readxl)
library(readr)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(countrycode)
library(scales)
library(maps)
library(DT)
library(lorem)
library(png)
library(grid)
library(tinytex)
library(corrplot)
library(here)
library(stringr)
library(janitor)
library(lubridate)
library(purrr)
library(ggcorrplot)
library(broom)

```
```{r}
getwd()
Datos_APILOL <- read_csv ("C:/Users/Rosalía Carballo/OneDrive/Documentos/Prueba_Trabajo_final_maestria/Datos/ryse_database.csv")
Datos <- Datos_APILOL
```
```{r}
#Depuración de datos

glimpse(Datos)
summary(Datos)

```
```{r}
cols_key   <- c("match_id","puuid")
cols_num   <- c("leaguePoints","gameDuration","champExperience","champLevel",
                "goldEarned","totalMinionsKilled","kills","deaths","assists",
                "totalDamageDealt","totalDamageTaken","damageDealtToBuildings",
                "damageDealtToObjectives","damageDealtToTurrets","visionScore",
                "baron_kills","dragon_kills","tower_kills","herald_kills",
                "inhibitor_kills","champion_kills","longestTimeSpentLiving",
                "timeCCingOthers","timePlayed","totalTimeCCDealt",
                "totalTimeSpentDead","totalAllyJungleMinionsKilled",
                "totalEnemyJungleMinionsKilled","totalHeal","totalHealsOnTeammates",
                "totalUnitsHealed","totalDamageShieldedOnTeammates")
```

```{r}
cols_chr   <- c("gameName","tagLine","tier","individualPosition","championName")
cols_date  <- c("date")       # YYYY-MM-DD ?
cols_dttm  <- c("datetime")   # ISO 8601 ?

# Limpieza rápida (espacios y tipos básicos)
dfc <- Datos %>%
  mutate(across(all_of(cols_chr), ~str_squish(as.character(.)))) %>%
  mutate(across(all_of(cols_num), ~suppressWarnings(as.numeric(.)))) %>%
  mutate(across(all_of(cols_date), ~suppressWarnings(as.Date(.)))) %>%
  mutate(across(all_of(cols_dttm), ~suppressWarnings(lubridate::ymd_hms(.)))) %>%
  clean_names()
```


```{r}
colSums(is.na(dfc))
```



```{r}
dfc |>
  ggplot(aes(x = tier, y = champ_level)) +
  geom_boxplot()
```
```{r}
dfc |>
  summarise(across(where(is.character), ~ n_distinct(.x)))
```

```{r}
unique(dfc$tier)
unique(dfc$champion_name)
```
Objetivo 1:

Definir el perfil y las características de los jugadores de rango Maestro, Gran Maestro y Challenger en League of Legends, considerando variables como experiencia, frecuencia de juego, rol preferido y el tipo de rol desempeñado dentro de las partidas, con el fin de caracterizar los estilos de juego asociados a cada categoría.


```{r}
#filtrarlos según Tier(rango alto)

datos_rango_alto <- dfc |>
  filter(tier %in% c("MASTER", "GRANDMASTER", "CHALLENGER"))

#Resumen Experiencia y frecuencia del juego

datos_rango_alto |>
  group_by(tier) |>
  summarise(
    promedio_experiencia = mean(champ_experience, na.rm = TRUE),
    sd_experiencia = sd(champ_experience, na.rm = TRUE),
    promedio_Tiempojugado = mean(time_played, na.rm = TRUE),
    sd_Tiempojugado = sd(time_played, na.rm = TRUE)
  )
```
```{r}
#Visualización de Experiencia y frecuencia del Juego

datos_rango_alto |>
  ggplot(aes(x = tier, y = champ_experience)) +
  geom_boxplot() +
  labs(title = "Distribución de experiencia por rango")

datos_rango_alto |>
  ggplot(aes(x = tier, y = time_played)) +
  geom_boxplot() +
  labs(title = "Frecuencia de juego por rango")
```
```{r}
#Resumen Posición desempeñada en partida
datos_rango_alto |>
  count(tier, individual_position) |>
  group_by(tier) |>
  mutate(porcentaje = n / sum(n) * 100) |>
  ggplot(aes(x = individual_position, y = porcentaje, fill = tier)) +
  geom_col(position = "dodge") +
  labs(title = "Posición desempeñada por rango")
```
Conclusiónes generales del objetivo 1.

Los Masters tienen un promedio de 13428.55 de experiencia de campeon, con una desviación estandar de 4562.527 y un tiempo jugado de	1630.551 con desviación estandar de	400.9034.Las posiciónes preferidas son Middle y Jungle.

Los Grandmaster tienen un promedio de 13027.64	de experiencia de campeon, con una desviación estandar de 4424.238 y un tiempo jugado de	1592.610	 con desviación estandar de 389.5518. Las posiciónes preferidas son Jungle y Bottom.

Los Challenger tienen un promedio de 12567.57	de experiencia de campeon, con una desviación estandar de 	4516.364	 y un tiempo jugado de 1594.505		 con desviación estandar de 381.2901. Las posiciónes preferidas son Utility y Jungle.


Objetivo 2

Definir y operacionalizar indicadores de rendimiento deportivo en e-sports sostenido, Tower Percentage, número de inhibidores destruidos, tiempo jugado,  tasa de victorias (winrate), oro ganado por minuto (GPM), KDA ajustado y control de objetivos, considerando además el componente temporal (por minuto o por fase de partida).

```{r}
# Winrate por rango

datos_rango_alto |>
  group_by(tier) |>
  summarise(
    winrate = mean(win, na.rm = TRUE),
    sd_winrate = sd(win, na.rm = TRUE),
  )

```

```{r}
#Oro ganado por duración de partida y KDA

datos_rango_alto <- datos_rango_alto |>
  mutate(
    gpm = gold_earned/ (game_duration / 60),
    kda_ajustado = (kills + assists) / pmax(1, deaths),
    )

datos_rango_alto |>
  group_by(tier) |>
  summarise(
    GPM = mean(gpm, na.rm = TRUE),
    sd_gpm = sd(gpm, na.rm = TRUE),
    KDA = mean(kda_ajustado, na.rm = TRUE),
    sd_Kda = sd(kda_ajustado, na.rm = TRUE),
  )

```

```{r}
#Torres
datos_rango_alto <- datos_rango_alto |>
  mutate(tower_dpm = damage_dealt_to_turrets / (game_duration / 60))

datos_rango_alto |>
  group_by(tier) |>
  summarise(
    DDTurrets = mean(tower_dpm, na.rm = TRUE),
    sd_DDTurrets = sd(tower_dpm, na.rm = TRUE),
  )

datos_rango_alto |>
  group_by(tier) |>
  summarise(
    avg_tower_kills = mean(tower_kills, na.rm = TRUE)
  )

```

```{r}
#Inhibidores

datos_rango_alto <- datos_rango_alto |>
  mutate(IPM = inhibitor_kills / (game_duration / 60))

datos_rango_alto |>
  group_by(tier) |>
  summarise(
    Inhibidores = mean(IPM, na.rm = TRUE),
    sd_IPM = sd(IPM, na.rm = TRUE),
  )

```
```{r}
#Control de objetivos
datos_rango_alto <- datos_rango_alto |>
  mutate(
    total_objetivos = dragon_kills + baron_kills + herald_kills + tower_kills
  )

datos_rango_alto |>
  group_by(tier) |>
  summarise(
    Objetivos = mean(total_objetivos, na.rm = TRUE),
    sd_Obj = sd(total_objetivos, na.rm = TRUE),
  )
```


```{r}
datos_rango_alto <- datos_rango_alto |>
  mutate(
    opm = total_objetivos / (game_duration / 60)
  )

datos_rango_alto |>
  group_by(tier) |>
  summarise(
    ObjetivosxM = mean(opm, na.rm = TRUE),
    sd_Opm = sd(opm, na.rm = TRUE),
  )
```

```{r}
datos_rango_alto |>
  group_by(tier) |>
  summarise(
    avg_opm = mean(opm, na.rm = TRUE),
    avg_dragons = mean(dragon_kills),
    avg_barons = mean(baron_kills),
    avg_heralds = mean(herald_kills)
  )
```
```{r}
#Tiempo vivo

datos_rango_alto <- datos_rango_alto |>
  mutate(TV = longest_time_spent_living / (game_duration / 60))

datos_rango_alto |>
  group_by(tier) |>
  summarise(
    Tiempovivo = mean(TV, na.rm = TRUE),
    sd_TV = sd(TV, na.rm = TRUE),
  )
```
```{r}
#Tiempo muerto

datos_rango_alto <- datos_rango_alto |>
  mutate(TM = total_time_spent_dead / (game_duration / 60))

datos_rango_alto |>
  group_by(tier) |>
  summarise(
    Tiempomuerto = mean(TM, na.rm = TRUE),
    sd_TM = sd(TM, na.rm = TRUE),
  )
```

```{r}
#Tiempo controlando

datos_rango_alto <- datos_rango_alto |>
  mutate(TC = total_time_cc_dealt / (game_duration / 60))

datos_rango_alto |>
  group_by(tier) |>
  summarise(
    Tiempocontrol = mean(TC, na.rm = TRUE),
    sd_TC = sd(TC, na.rm = TRUE),
  )
```
ConclusiOnes generales del objetivo 2.

Por indicadores de resultado:
Para los Challenger el 

```{r}
resumen_rango_rol <- datos_rango_alto |>
  group_by(tier, individual_position) |>
  summarise(
    partidas = n(),
    winrate = mean(win, na.rm = TRUE) * 100,
    gpm = mean(gold_earned / (game_duration / 60), na.rm = TRUE),
    kda = mean((kills + assists) / pmax(1, deaths), na.rm = TRUE),
    objetivos = mean(dragon_kills + baron_kills + herald_kills, na.rm = TRUE),
    cc_pm = mean(total_time_cc_dealt / game_duration * 60, na.rm = TRUE),
    .groups = "drop"
  )

resumen_rango_rol |>
  ggplot(aes(x = individual_position, y = winrate, fill = tier)) +
  geom_col(position = "dodge") +
  labs(
    title = "Winrate por posición y rango",
    x = "Rol",
    y = "Winrate (%)"
  )
```
```{r}
#Oro por minuto visualización

resumen_rango_rol |>
  ggplot(aes(x = individual_position, y = gpm, fill = tier)) +
  geom_col(position = "dodge") +
  labs(
    title = "GPM por posición y rango",
    x = "Rol",
    y = "Oro por minuto"
  )
```
```{r}
resumen_rango_rol |>
  ggplot(aes(x = individual_position, y = kda, fill = tier)) +
  geom_col(position = "dodge") +
  labs(
    title = "KDA ajustado por posición y rango",
    x = "Rol",
    y = "KDA"
  )
```
```{r}
datos_rango_alto |>
  ggplot(aes(x = individual_position, y = game_duration / 60)) +  # convertimos a minutos
  geom_jitter(alpha = 0.4, color = "steelblue") +
  stat_summary(fun = mean, geom = "point", shape = 18, size = 4, color = "red") +
  labs(
    title = "Duración de partida por jugador según rol",
    x = "Rol desempeñado",
    y = "Tiempo jugado (minutos)"
  ) +
  theme_minimal()
```
```{r}
datos_rango_alto |>
  ggplot(aes(x = game_duration / 60, y = fct_inorder(puuid), color = individual_position)) +
  geom_point(alpha = 0.6) +
  labs(
    title = "Tiempo jugado por jugador, según rol y rango",
    x = "Duración de partida (minutos)",
    y = "Jugador (puuid)",
    color = "Rol"
  ) +
  facet_wrap(~ tier) +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )
```
```{r}
datos_challenger <- datos_rango_alto |>
  filter(tier == "CHALLENGER")


library(ggplot2)
library(forcats)

datos_challenger |>
  ggplot(aes(x = game_duration / 60, y = fct_inorder(puuid), color = individual_position)) +
  geom_point(alpha = 0.6, size = 2) +
  labs(
    title = "Duración de partida por jugador (Challenger)",
    x = "Tiempo jugado (minutos)",
    y = "Jugador (puuid)",
    color = "Rol"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )
```
```{r}
datos_master <- datos_rango_alto |>
  filter(tier == "MASTER")


library(ggplot2)
library(forcats)

datos_challenger |>
  ggplot(aes(x = game_duration / 60, y = fct_inorder(puuid), color = individual_position)) +
  geom_point(alpha = 0.6, size = 2) +
  labs(
    title = "Duración de partida por jugador (Master)",
    x = "Tiempo jugado (minutos)",
    y = "Jugador (puuid)",
    color = "Rol"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )
```
```{r}
datos_granmaster <- datos_rango_alto |>
  filter(tier == "GRANDMASTER")


library(ggplot2)
library(forcats)

datos_challenger |>
  ggplot(aes(x = game_duration / 60, y = fct_inorder(puuid), color = individual_position)) +
  geom_point(alpha = 0.6, size = 2) +
  labs(
    title = "Duración de partida por jugador (Gran Master)",
    x = "Tiempo jugado (minutos)",
    y = "Jugador (puuid)",
    color = "Rol"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )
```
```{r}
#Correlaciones

vars_cor <- datos_rango_alto %>%
  select(win, gpm, kda_ajustado, total_objetivos)

# Calcular matriz de correlaciones
cor_matrix <- cor(vars_cor, use = "complete.obs")

cor_matrix

```
```{r}
#Hipotesis planteada:
#Existe una correlación positiva entre los principales indicadores de rendimiento competitivo, como la tasa de victorias (winrate), el oro ganado por minuto (GPM), el KDA ajustado y el control de objetivos.


ggcorrplot(cor_matrix, 
           hc.order = TRUE, 
           type = "lower",
           lab = TRUE,
           lab_size = 4,
           colors = c("red", "white", "blue"),
           title = "Correlación entre Winrate, GPM, KDA y Control de Objetivos",
           ggtheme = theme_minimal())
```

```{r}
#Hipotesis planteada: 
#La tasa de victorias (winrate) se correlaciona positivamente con el porcentaje de torres destruidas (Tower Percentage) y, a su vez, este indicador se relaciona con el número de inhibidores destruidos, lo que sugiere una progresión estratégica en el control del mapa.

library(scales)

MAX_TOWERS <- 11

df_side <- datos_rango_alto %>%
  group_by(match_id, win) %>%                 # dos grupos por partida: win=1 (ganador), win=0 (perdedor)
  summarise(
    tower_kills     = sum(tower_kills, na.rm = TRUE),
    inhibitor_kills = sum(inhibitor_kills, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    tower_pct = pmin(tower_kills / MAX_TOWERS, 1),
    winrate   = as.numeric(win)               # 0 o 1
  )

# 2) Correlaciones
cor_win_tower <- cor.test(df_side$winrate, df_side$tower_pct,     use = "complete.obs")
cor_tower_inh <- cor.test(df_side$tower_pct, df_side$inhibitor_kills, use = "complete.obs")

cor_win_tower
cor_tower_inh

# 3) Gráficos de apoyo
# Winrate (0/1) vs % torres (con curva logística)
ggplot(df_side, aes(x = tower_pct, y = winrate)) +
  geom_jitter(width = 0.02, height = 0.02, alpha = 0.25) +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE) +
  scale_x_continuous(labels = percent_format(accuracy = 1)) +
  labs(title = "Winrate vs % de torres destruidas",
       x = "% de torres destruidas", y = "Winrate (0/1)") +
  theme_minimal()

# Inhibidores vs % torres
ggplot(df_side, aes(x = tower_pct, y = inhibitor_kills)) +
  geom_point(alpha = 0.35) +
  geom_smooth(method = "lm", se = TRUE) +
  scale_x_continuous(labels = percent_format(accuracy = 1)) +
  labs(title = "Inhibidores destruidos vs % de torres destruidas",
       x = "% de torres destruidas", y = "Inhibidores destruidos") +
  theme_minimal()

```
#Que significan los valores

**Winrate vs torres destruidas**

cor = 0.685 → Correlación positiva y fuerte: cuando un lado destruye más torres, tiene mucha más probabilidad de ganar la partida.

p-value < 2.2e-16 → Esta relación no es por azar, es estadísticamente significativa.

IC 95% (0.676–0.694) → El valor verdadero de la correlación poblacional está en ese rango; siempre positivo y bastante alto.

**Torres destruidas vs inhibidores destruidos**

cor = 0.735 → Correlación positiva todavía más fuerte: cuantos más porcentajes de torres caen, más inhibidores se destruyen.

p-value < 2.2e-16 → Extremadamente significativo.

IC 95% (0.727–0.743) → La relación real casi seguro está en este rango alto.
```{r}
#Normalizar por duración

df <- datos_rango_alto %>%
  mutate(
    minutes = pmax(time_played/60, 1),
    gpm          = gold_earned / minutes,
    kda_adj      = (kills + assists) / pmax(deaths, 1),
    cs_min       = total_minions_killed / minutes,
    dmg_dealt_min= total_damage_dealt / minutes,
    dmg_taken_min= total_damage_taken / minutes,
    vision_min   = vision_score / minutes,
    cc_min       = (time_c_cing_others + total_time_cc_dealt) / (2*minutes)
  )

ggplot(df, aes(x = gpm)) + geom_histogram(bins = 50)
```

```{r}
df <- df %>%
  mutate(
    obj_epicos = dragon_kills + herald_kills + baron_kills,
    oci_raw    = 0.4*tower_kills + 0.3*inhibitor_kills + 0.3*obj_epicos
  ) %>%
  group_by(individual_position) %>%            # opcional: normaliza por rol
  mutate(oci = scale(oci_raw)[,1]) %>%
  ungroup()

ggplot(df, aes(x = individual_position, y = oci)) + geom_boxplot()
```

```{r}
#Predición de victoria
m1 <- glm(win ~ gpm + kda_adj + oci + vision_min + dmg_dealt_min + cc_min,
          data = df, family = binomial())
broom::tidy(m1) |>
  mutate(odds_ratio = exp(estimate)) |>
  select(term, estimate, odds_ratio, p.value)
```
```{r}
coefs <- broom::tidy(m1) |> mutate(odds = exp(estimate))
ggplot(coefs, aes(x = reorder(term, odds), y = odds)) +
  geom_point() + coord_flip() + geom_hline(yintercept=1, linetype=2)
```

```{r}
library(ranger)

rf <- ranger(
  win ~ gpm + kda_adj + oci + vision_min + dmg_dealt_min + dmg_taken_min + cs_min + cc_min,
  data = df, probability = TRUE, importance = "impurity"
)

sort(rf$variable.importance, decreasing = TRUE)
```







